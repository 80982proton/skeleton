# Deployment and Development Recommendations

## General

In that section you can find out useful information related to the development and deployment process. 

There are several crucial things which you have to figure out, after you ran a project:

* Which elements should be stored in the control system?
* How to import and rebuild classes required on every environment?
* How to work with multi-environment infrastructure?

## Development

If this is you first Pimcore project, find more information about the installation in the [Getting Started section](../01_Getting_Started/README.md).

### VCS / GIT

Projects based on Pimcore contain files which you shouldn't add to the repository.
In the most cases you can add following rules to the `.gitignore` file.

```
.idea/
.idea_modules/
node_modules/
!website/var/
website/var/*
!website/var/config/
website/var/config/*.mmdb
!website/var/classes/
website/var/classes/Object
vendor/
 
.DS_Store
Thumbs.db

# tests
/tests/output/*
/tests/tmp/*

# composer
/composer.phar
/composer.lock
/vendor/*
!/vendor/.dummy

# misc
/php-cs-fixer.phar
```

These rules ignore files generated by IDE, cache files, tmp files and external libraries updated by Composer.

### Multi-environment

#### The `PIMCORE_ENVIRONMENT` Variable

A special variable called `PIMCORE_ENVIRONMENT` is available in Pimcore. You can choose the value between *test* and *development*.
It provides special order in loading configuration files. 
Have a look at the example for `PIMCORE_ENVIRONMENT = development`. 
The following order flow will be kept in that case.

```
website/config/system.development.php
website/var/config/system.development.php
website/config/system.php
website/var/config/system.php
```

The value of `PIMCORE_ENVIRONMENT` is used as a part of the file name.

If you haven't set the environment variable, the loading order of configuration files looks like, below.

```
website/config/system.php
website/var/config/system.php
```

So, you can put your custom configurations into `website/config` where the configuration file is also not writable by the pimcore admin interface. 

#### Set the Environment

**Apache mod_php**

Add the following line to the virtual host configuration file.

```
SetEnv PIMCORE_ENVIRONMENT development
```

**PHP FPM**

Add the following line to your `pool.d` configuration file.

```
env[PIMCORE_ENVIRONMENT] = "development"
```

**CLI**

If you used a Unix system you would set the variable by CLI, like below.

```
PIMCORE_ENVIRONMENT="development"; export PIMCORE_ENVIRONMENT
```

**console.php commands**

When running `pimcore/cli/console.php` application, set the environment by `--environment=development`.
 
```
php /path/to/pimcore/cli/console.php --environment=development ...
```

## Deployment

### Pimcore Components Structures

Every Pimcore component (classes, field collections, translations, settings) are transportable between environments.
Almost everything related to settings is saved as a PHP config file under the `/website/var/config` directory.

* Document-Types
* Extension Config
* Image Thumbnails
* Predefined Properties
* QR-Codes
* Report Configs
* Static-Routes
* System Settings
* Tag Manager
* Video Thumbnails
* Cache
* Custom-Views
* Dependency Injection
* Perspectives
* Web-to-Print
* Workflows

These settings could also be stored in the filesystem with an appropriated file permissions. 
Due to that, you're able to disallow admin users updating those values.

Find, config examples on Github:

* <https://github.com/pimcore/pimcore/tree/master/website_demo/var/config> 
* <https://github.com/pimcore/pimcore/tree/master/website_demo/config>


### Content migration

The content migration between environments is not provided in Pimcore and also, it's not recommended. 
The content should be created by editors in the production environment and visiblity on the frontend could be managed 
by built-in features like publishing / unpublishing / [versioning](../08_Tools_and_Features/01_Versioning.md) / [scheduling](../08_Tools_and_Features/03_Scheduling.md) / preview the effect in editmode.
Therefore, editors shouldn't work on different stages. 

Of course, the content migration is possible by the complex [assets](../04_Assets/01_Working_with_PHP_API.md), 
[objects](../05_Objects/03_Working_with_PHP_API.md) and [documents](../03_Documents/09_Working_with_PHP_API.md) PHP API. 
Still, if it's not necessary the content migration shouldn't be provided to the project.

### Rebuild Classes

In the `pimcore/cli/console.php` script you can find a powerful command called `deployment:classes-rebuild`.

If any change in classes, field collections, object bricks is pushed, that command takes care about updating the database.

So, what is the flow of classes migration? 

* One developer created a new class called *Product*
* The class has to exists in databases of other developers. 
You can use for example import commands to migrate classes, field collections, object bricks `` from a json file (exported from the administration panel).

```bash
php pimcore/cli/console.php definition:import:objectbrick /brick_jsonfile_path.json
```

```bash
php pimcore/cli/console.php definition:import:fieldcollection /collection_jsonfile_path.json
```

```bash
php pimcore/cli/console.php definition:import:class /class_jsonfile_path.json
```

* After every code update you should use the `deployment:classes-rebuild` command to push changes to the database.
 
```bash
php pimcore/cli/console.php deployment:classes-rebuild
```

### CLI Features

In the `pimcore/cli/console.php` many additional commands have been also implemented.
To find it out, use `list` command.

```bash
php pimcore/cli/console.php list
```

Available commands:

| Command                                              | Description                                                                                     |
|------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| backup                                               | Creates .zip archive of document root                                                           |
| classmap-generator                                   | Generate class maps to improve performance                                                      |
| compatibility-stubs                                  | Generate stub files for non-namespaced (before pimcore 3) class names                           |
| help                                                 | Displays help for a command                                                                     |
| list                                                 | Lists commands                                                                                  |
| maintenance                                          | Asynchronous maintenance jobs of pimcore (needs to be set up as cron job)                       |
| mysql-tools                                          | Optimize and warmup mysql database                                                              |
| reset-password                                       | Reset a user's password                                                                         |
| search-backend-reindex                               | Re-indexes the backend search of pimcore                                                        |
| update                                               | Update pimcore to the desired version/build                                                     |
| cache:clear                                          | Clear caches                                                                                    |
| cache:warming                                        | Warm up caches                                                                                  |
| classificationstore:delete-store                     | Delete Classification Store                                                                     |
| definition:import:class                              | Import Class definition from a JSON export                                                      |
| definition:import:fieldcollection                    | Import FieldCollection definition from a JSON export                                            |
| definition:import:objectbrick                        | Import ObjectBrick definition from a JSON export                                                |
| deployment:classes-rebuild                           | rebuilds classes and db structure based on updated `website/var/classes/definition_*.php` files |
| internal:newsletter-document-send                    | For internal use only                                                                           |
| internal:unicode-cldr-language-territory-generator   | For internal use only                                                                           |
| internal:update-processor                            | For internal use only                                                                           |
| internal:video-converter                             | For internal use only                                                                           |
| thumbnails:image                                     | Generate image thumbnails, useful to pre-generate thumbnails in the background                  |
| thumbnails:optimize-images                           | Optimize filesize of all images in `/vagrant/www/pimcore/website/var/tmp`                       |
| thumbnails:video                                     | Generate video thumbnails, useful to pre-generate thumbnails in the background                  |
| web2print:pdf-creation                               | Start pdf creation                                                                              |

Find more about the Pimcore console from the [dedicated page](../09_Development_Tools_and_Details/11_Console_CLI.md).